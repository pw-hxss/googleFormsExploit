// ==UserScript==
// @name         谷歌表格自动解答
// @namespace    https://docs.google.com/forms/
// @version      0.1
// @description  解剖谷歌表格的内部数据，自动填充正确答案
// @match        https://docs.google.com/forms/*
// @grant        none
// @run-at       document-start
// ==/UserScript==

(function() {
    'use strict';

    // skip form if already filled by url params
    if(location.href.indexOf("?entry.") > 0) return;

    var inputAreas = document.querySelectorAll("div[data-params]");
    var urlPrefillParams = new URLSearchParams();

    inputAreas.forEach((inputArea) => {
        try {

            var areaParams = inputArea.getAttribute("data-params");
            var decodedAreaParams = JSON.parse("[" + areaParams.substr(areaParams.indexOf("["), areaParams.length));
            var questionParams = decodedAreaParams[0][4][0];
            var questionEntryId = questionParams[0];
            var validationParams = questionParams[4];

            // if validation disabled
            if(validationParams.length === 0) return;

            var validationRule = validationParams[0];
            var valueToFill = null;

            // type: number && match: equal to
            if(validationRule[0] === 1 && validationRule[1] === 5) {
                valueToFill = validationRule[2][0];
            }

            // type: text && match: contains
            if(validationRule[0] === 2 && validationRule[1] === 100) {
                valueToFill = validationRule[2][0];
            }

            if(valueToFill !== null) urlPrefillParams.set("entry." + questionEntryId, valueToFill);

        } catch(ex) {
            console.error("搜索失败 [datatype mismatch error]", ex, inputArea);
        }
    });

    if(Array.from(urlPrefillParams).length > 0) {
        if(confirm("搜索到 " + Array.from(urlPrefillParams).length + " 条既定数据。 是否自动填充表格。")) {
            location.search = urlPrefillParams;
        }
    }
})();
